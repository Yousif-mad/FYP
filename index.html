<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Maintenance Work Orders Calendar</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
  <style>
    /* Sidebar */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      height: 100vh;
      width: 100px;
      background-color: #2f3e4e;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0;
      box-shadow: 2px 0 8px rgba(0,0,0,0.15);
      z-index: 1000;
    }
    .sidebar #image {
      width: 100%;
      height: auto;
      object-fit: cover;
      margin: 0;
      padding-bottom: 120px;
      display: block;
    }
    /* Nav items */
    .nav-item {
      color: #a9b3c1;
      text-align: center;
      margin: 20px 0;
      cursor: pointer;
      width: 70px;
      transition: color 0.3s ease, background-color 0.3s ease;
      border-radius: 12px;
      padding: 10px 0;
      text-decoration: none;
      user-select: none;
    }
    .nav-item i {
      font-size: 28px;
      display: block;
      margin-bottom: 8px;
    }
    .nav-item span {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.04em;
    }
    .nav-item:hover {
      color: #ffffff;
      background-color: #1e90ff;
      box-shadow: 0 4px 12px rgba(30,144,255,0.6);
    }
    .nav-item.active {
      color: #ffffff;
      background-color: #007acc;
      box-shadow: 0 4px 15px rgba(0,122,204,0.8);
    }
    /* Main body */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 20px 20px 20px 120px; /* Leave space for sidebar */
      background: #f9fafb;
      color: #333;
      min-height: 100vh;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #2c3e50;
      user-select: none;
    }
    #calendar {
      opacity: 0.9;
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgb(0 0 0 / 0.1);
      padding: 10px;
      cursor: default;
    }
    .fc-event {
      cursor: pointer;
      transition: background-color 0.3s ease, color 0.3s ease;
      border-radius: 6px;
      padding: 2px 5px;
      font-weight: 600;
    }
    .fc-event:hover {
      background-color: #3498db !important;
      color: white !important;
      box-shadow: 0 0 8px #2980b9;
    }
    .fc-event.urgent-event {
      background-color: #e74c3c !important;
      border-color: #c0392b !important;
      color: white !important;
      box-shadow: 0 0 10px #c0392b !important;
    }
    button#addOrderBtn {
      display: block;
      margin: 0 auto 25px auto;
      padding: 12px 25px;
      font-size: 1.1rem;
      border: none;
      background: #27ae60;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      box-shadow: 0 3px 6px rgb(0 0 0 / 0.2);
      user-select: none;
      width: 200px;
    }
    button#addOrderBtn:hover {
      background: #2ecc71;
    }
    button#clearCalendarBtn {
      display: block;
      margin: 0 auto 25px auto;
      padding: 12px 25px;
      font-size: 1.1rem;
      border: none;
      background: #c0392b;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 3px 6px rgb(0 0 0 / 0.2);
      user-select: none;
      width: 200px;
    }
    button#clearCalendarBtn:hover {
      background: #e74c3c;
    }
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    .modal-content {
      background: white;
      border-radius: 10px;
      box-shadow: 0 8px 24px rgb(0 0 0 / 0.2);
      max-width: 900px;
      width: 95%;
      max-height: 90vh;
      display: flex;
      overflow: hidden;
      user-select: none;
    }
    form#workOrderForm {
      flex: 2;
      padding: 25px 30px;
      display: flex;
      flex-direction: column;
      gap: 15px;
      overflow-y: auto;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .form-group label {
      font-weight: 600;
      color: #34495e;
      user-select: text;
    }
    input[type="text"],
    input[type="date"],
    select,
    textarea {
      padding: 8px 10px;
      font-size: 1rem;
      border: 1.8px solid #ccc;
      border-radius: 6px;
      transition: border-color 0.3s ease;
      resize: vertical;
    }
    input[type="text"]:focus,
    input[type="date"]:focus,
    select:focus,
    textarea:focus {
      border-color: #2980b9;
      outline: none;
      box-shadow: 0 0 6px #3498db;
    }
    textarea {
      min-height: 80px;
      font-family: inherit;
    }
    select[disabled] {
      background: #f0f0f0;
      color: #7f8c8d;
      cursor: not-allowed;
    }
    .button-row {
      display: flex;
      gap: 12px;
      margin-top: 10px;
    }
    button[type="submit"], button#cancelBtn {
      flex: 1;
      padding: 10px 15px;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      font-weight: 700;
      user-select: none;
      transition: background-color 0.3s ease;
      box-shadow: 0 3px 6px rgb(0 0 0 / 0.1);
    }
    button[type="submit"] {
      background-color: #2980b9;
      color: white;
    }
    button[type="submit"]:hover {
      background-color: #3498db;
    }
    button#cancelBtn {
      background-color: #bdc3c7;
      color: #2c3e50;
    }
    button#cancelBtn:hover {
      background-color: #95a5a6;
    }
    button#deleteBtn {
      background-color: #e74c3c;
      color: white;
      display: none;
    }
    button#deleteBtn:hover {
      background-color: #c0392b;
    }
    select#orderStatus {
      font-weight: 600;
      color: #34495e;
    }
    .form-group.urgent-group {
      flex-direction: row;
      align-items: center;
      gap: 10px;
    }
    .form-group.urgent-group label {
      margin: 0;
      font-weight: 600;
      user-select: text;
      color: #e74c3c;
    }
    /* Right panel chat */
    .right-panel {
      flex: 1;
      background: #f5f8fa;
      border-left: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
    }
    .right-panel h3 {
      margin-top: 0;
      margin-bottom: 15px;
      font-weight: 700;
      color: #2c3e50;
      user-select: text;
      border-bottom: 2px solid #2980b9;
      padding-bottom: 6px;
    }
    #chatMessages {
      flex: 1;
      overflow-y: auto;
      padding-right: 10px;
      margin-bottom: 15px;
      border-radius: 6px;
      background: white;
      box-shadow: inset 0 0 8px rgb(0 0 0 / 0.05);
    }
    .chat-message {
      margin-bottom: 12px;
      padding: 8px 10px;
      border-radius: 8px;
      background: #ecf0f1;
      color: #2c3e50;
      user-select: text;
      word-wrap: break-word;
    }
    .chat-message .meta {
      font-size: 0.75rem;
      font-weight: 600;
      color: #7f8c8d;
      margin-bottom: 4px;
      user-select: text;
    }
    #chatInput {
      border: 1.5px solid #ccc;
      border-radius: 6px;
      padding: 10px;
      font-size: 1rem;
      width: 100%;
      box-sizing: border-box;
      resize: none;
      height: 50px;
      transition: border-color 0.3s ease;
    }
    #chatInput:focus {
      border-color: #2980b9;
      outline: none;
      box-shadow: 0 0 6px #3498db;
    }
    #sendChatBtn {
      margin-top: 8px;
      background-color: #27ae60;
      border: none;
      color: white;
      font-weight: 700;
      font-size: 1rem;
      padding: 10px 0;
      width: 100%;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      user-select: none;
      box-shadow: 0 3px 6px rgb(0 0 0 / 0.15);
    }
    #sendChatBtn:hover:not(:disabled) {
      background-color: #2ecc71;
    }
    #sendChatBtn:disabled {
      background-color: #95a5a6;
      cursor: not-allowed;
      box-shadow: none;
    }
    /* Background watermark */
    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url('logo1.jpeg');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      opacity: 0.5;
      z-index: -1;
    }
    /* Alert bar */
    .alert-bar {
      position: fixed;
      top: 50px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #e74c3c;
      color: white;
      padding: 15px 25px;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(231, 76, 60, 0.8);
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 3100;
      user-select: none;
    }
    .alert-bar i {
      font-size: 24px;
    }
    /* Dark mode toggle button */
    #darkModeToggle {
      position: fixed;
      top: 15px;
      right: 15px;
      background-color: #ffffff;
      border: none;
      padding: 10px 14px;
      border-radius: 50%;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      font-size: 20px;
      color: #f39c12;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 4000;
      user-select: none;
    }
    #darkModeToggle:hover {
      background-color: #e0f7fa;
      transform: scale(1.1);
    }
    body.dark-mode #darkModeToggle {
      background-color: #2c3e50;
      color: #ecf0f1;
    }
    body.dark-mode #darkModeToggle:hover {
      background-color: #34495e;
    }
    #darkModeToggle:focus {
      outline: 3px solid #2980b9;
      outline-offset: 2px;
    }
    /* Dark mode styles */
    body.dark-mode {
      background-color: #121212;
      color: #e0e0e0;
    }
    body.dark-mode #calendar {
      background: #212121;
      color: #e0e0e0;
      box-shadow: 0 4px 10px rgb(255 255 255 / 0.1);
    }
    body.dark-mode .sidebar {
      background-color: #1c2733;
      box-shadow: 2px 0 8px rgba(255,255,255,0.1);
    }
    body.dark-mode .nav-item {
      color: #a9b3c1;
    }
    body.dark-mode .nav-item:hover,
    body.dark-mode .nav-item.active {
      color: #f39c12;
      background-color: transparent;
      box-shadow: none;
    }
    body.dark-mode button#addOrderBtn {
      background-color: #27ae60;
      color: #e0e0e0;
      box-shadow: 0 3px 6px rgb(0 0 0 / 0.8);
    }
    body.dark-mode button#clearCalendarBtn {
      background-color: #c0392b;
      box-shadow: 0 3px 6px rgb(0 0 0 / 0.8);
    }
    body.dark-mode button#addOrderBtn:hover {
      background-color: #2ecc71;
    }
    body.dark-mode button#clearCalendarBtn:hover {
      background-color: #e74c3c;
    }
    body.dark-mode .modal-content {
      background: #333;
      color: #e0e0e0;
    }
    body.dark-mode input[type="text"],
    body.dark-mode input[type="date"],
    body.dark-mode select,
    body.dark-mode textarea {
      background-color: #222;
      border-color: #555;
      color: #e0e0e0;
    }
    body.dark-mode input[type="text"]:focus,
    body.dark-mode input[type="date"]:focus,
    body.dark-mode select:focus,
    body.dark-mode textarea:focus {
      border-color: #f39c12;
      box-shadow: 0 0 8px #f39c12;
      outline: none;
    }
    body.dark-mode .right-panel {
      background: #222;
      border-color: #555;
      color: #e0e0e0;
    }
    body.dark-mode #chatInput {
      background-color: #222;
      color: #e0e0e0;
      border-color: #555;
    }
    body.dark-mode #sendChatBtn {
      background-color: #27ae60;
      box-shadow: 0 3px 6px rgb(0 0 0 / 0.8);
    }
    body.dark-mode #sendChatBtn:disabled {
      background-color: #555;
      cursor: not-allowed;
      box-shadow: none;
    }
    .filter-bar {
      max-width: 900px;
      margin: 0 auto 20px auto;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .filter-btn {
      padding: 10px 18px;
      border: none;
      background-color: #3498db;
      color: white;
      border-radius: 8px;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
      user-select: none;
    }

    .filter-btn:hover {
      background-color: #2980b9;
    }

    .filter-btn.active {
      background-color: #1abc9c;
      box-shadow: 0 0 10px #1abc9c;
    }

    body.dark-mode .filter-btn {
      background-color: #3a3a3a;
      color: #f0f0f0;
    }

    body.dark-mode .filter-btn:hover {
      background-color: #555;
    }

    body.dark-mode .filter-btn.active {
      background-color: #16a085;
      box-shadow: 0 0 10px #16a085;
    }
    /* Buttons container */
#viewToggleContainer {
  margin: 1rem 0;
  display: flex;
  gap: 1rem;
  justify-content: flex-start; /* Align left, you can change to center or right */
}

/* Shared button styles (same as your other buttons) */
#calendarViewBtn,
#tableViewBtn {
  background-color: #3498db; /* Blue color */
  color: white;
  border: none;
  padding: 0.5rem 1.2rem;
  font-size: 1rem;
  font-weight: 600;
  border-radius: 5px;
  cursor: pointer;
  transition: background-color 0.3s ease, transform 0.2s ease;
  box-shadow: 0 3px 6px rgba(0,0,0,0.16);
}

#calendarViewBtn:hover:not(:disabled),
#tableViewBtn:hover:not(:disabled) {
  background-color: #2980b9;
  transform: translateY(-2px);
}

#calendarViewBtn:disabled,
#tableViewBtn:disabled {
  background-color: #95a5a6;
  cursor: default;
  transform: none;
  box-shadow: none;
}

/* Table container */
#tableViewContainer {
  margin-top: 1rem;
  overflow-x: auto; /* Horizontal scroll on small screens */
}

/* Table styles */
#workOrdersTable {
  width: 100%;
  border-collapse: collapse;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  border-radius: 8px;
  overflow: hidden;
  background: white;
}

/* Table header */
#workOrdersTable thead {
  background-color: #2980b9;
  color: white;
  user-select: none;
}

#workOrdersTable thead th {
  padding: 0.75rem 1rem;
  text-align: left;
  cursor: pointer;
  white-space: nowrap;
}

/* Table body */
#workOrdersTable tbody tr {
  border-bottom: 1px solid #ddd;
  transition: background-color 0.3s ease;
  cursor: pointer;
}

#workOrdersTable tbody tr:hover {
  background-color: #f1f8ff;
}

/* Table cells */
#workOrdersTable tbody td {
  padding: 0.6rem 1rem;
  vertical-align: middle;
  white-space: nowrap;
}

/* Responsive - make sure buttons and table don't overflow container */
@media (max-width: 600px) {
  #viewToggleContainer {
    flex-direction: column;
    gap: 0.5rem;
  }
  #calendarViewBtn,
  #tableViewBtn {
    width: 100%;
  }
}
body.dark-mode #tableViewContainer {
  background-color: #121212; /* dark container bg */
  padding: 1rem;
  border-radius: 8px;
}

body.dark-mode #workOrdersTable {
  background-color: #1e1e1e; /* dark table bg */
  color: #ddd; /* light text */
  box-shadow: 0 4px 8px rgba(255,255,255,0.1);
}

body.dark-mode #workOrdersTable thead {
  background-color: #333; /* darker header */
  color: #eee;
}

body.dark-mode #workOrdersTable tbody tr {
  border-bottom: 1px solid #444;
}

body.dark-mode #workOrdersTable tbody tr:hover {
  background-color: #333844; /* subtle highlight on hover */
  color: #fff;
}

body.dark-mode #workOrdersTable tbody td {
  color: #ddd;
}

/* Optional: make the table header pointer icon lighter in dark */
body.dark-mode #dateHeader {
  color: #ccc;
}/* Container for toggle buttons */
#viewToggleGroup {
  display: ce;
  border-radius: 30px;
  background: var(--btn-bg, #f0f0f0);
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  margin: 1rem auto; /* center horizontally with vertical spacing */
  padding: 0;
  user-select: none;
  justify-content: center;

  /* center container horizontally */
  width: fit-content;
}

/* Shared button styles */
#viewToggleGroup button {
  border: none;
  background: none;
  padding: 0.5rem 1.5rem;
  cursor: pointer;
  font-weight: 600;
  font-size: 1rem;
  color: var(--btn-text, #555);
  transition: background-color 0.3s, color 0.3s;
  user-select: none;
}

/* Rounded corners on edges */
#viewToggleGroup button:first-child {
  border-top-left-radius: 30px;
  border-bottom-left-radius: 30px;
}
#viewToggleGroup button:last-child {
  border-top-right-radius: 30px;
  border-bottom-right-radius: 30px;
}

/* Active button style */
#viewToggleGroup button.active {
  background-color: #4a90e2;
  color: white;
  box-shadow: 0 4px 10px rgba(74,144,226,0.4);
}

/* Hover for inactive */
#viewToggleGroup button:hover:not(.active) {
  background-color: #dde9fb;
  color: #4a90e2;
}

/* Dark mode styles */
body.dark-mode #viewToggleGroup {
  background: #2c2c2c;
  box-shadow: 0 0 10px rgba(255,255,255,0.1);
}
body.dark-mode #viewToggleGroup button {
  color: #aaa;
}
body.dark-mode #viewToggleGroup button.active {
  background-color: #357abd;
  box-shadow: 0 4px 10px rgba(53,122,189,0.7);
  color: white;
}
body.dark-mode #viewToggleGroup button:hover:not(.active) {
  background-color: #3a3a3a;
  color: #7aa9e9;
}


  </style>
</head>
<body>
  <div class="sidebar" role="navigation" aria-label="Main navigation">
    <img id="image" src="logo1.jpeg" alt="Company logo" />
    
    <a class="nav-item" href="index.html" title="Work Orders (WO)" aria-current="page">
      <i class="fas fa-tools" aria-hidden="true"></i>
      <span>WO</span>
    </a>

    <a class="nav-item" href="assets.html" title="Assets">
      <i class="fas fa-boxes" aria-hidden="true"></i>
      <span>Assets</span>
    </a>

    <a class="nav-item" href="inventory.html" title="Inventory">
      <i class="fas fa-warehouse" aria-hidden="true"></i>
      <span>Inventory</span>
    </a>
  </div>

  <h1 id="pageTitle">Work Orders Calendar</h1>

  <button id="darkModeToggle" title="Toggle Dark Mode" aria-label="Toggle Dark Mode">
    <i class="fas fa-sun" aria-hidden="true"></i>
  </button>

  <div class="filter-bar" role="region" aria-label="Work order filters" style="max-width:900px;margin:0 auto 25px auto;display:flex;flex-wrap:wrap;gap:8px;justify-content:center;">
    <button class="filter-btn active" data-filter="All" data-type="status" aria-pressed="true">All Status</button>
    <button class="filter-btn" data-filter="To Do" data-type="status" aria-pressed="false">To Do</button>
    <button class="filter-btn" data-filter="Done" data-type="status" aria-pressed="false">Done</button>

    <button class="filter-btn active" data-filter="All" data-type="station" aria-pressed="true">All Stations</button>
    <button class="filter-btn" data-filter="Boiler Station" data-type="station" aria-pressed="false">Boiler Stations</button>
    <button class="filter-btn" data-filter="Palm Oil Station" data-type="station" aria-pressed="false">Palm Oil Station</button>
    
    <button class="filter-btn" data-filter="Urgent" data-type="urgent" aria-pressed="false" style="background-color:#e74c3c; color:white;">Urgent Only</button>
  </div>
  



  <div id="buttonContainer" style="max-width: 900px; margin: 0 auto 25px auto; display: flex; flex-direction: column; align-items: center; gap: 12px;">
    <button id="addOrderBtn" aria-haspopup="dialog" aria-controls="orderModal">Add Work Order</button>
    <button id="clearCalendarBtn" style="background-color:#c0392b; color:white;" aria-label="Clear all work orders from calendar">Clear Calendar</button>
  </div>
  

<div id="viewToggleGroup" aria-label="Toggle calendar or table view" role="group">
  <div style="text-align:center; margin: 10px;">
  <button id="exportPdfBtn">📄 Export Table to PDF</button>
</div>

  <button id="calendarViewBtn" class="active" aria-pressed="true">
    📅 Calendar
  </button>
  <button id="tableViewBtn" aria-pressed="false">
    📋 Table
  </button>
</div>
  <div id="calendar" aria-label="Work orders calendar"></div>
  <div id="tableViewContainer" style="display:none;">
  <table id="workOrdersTable" border="1" style="width:100%; border-collapse: collapse;">
    <thead>
      <tr>
        <th>Title</th>
        <th>Description</th>
        <th id="dateHeader" style="cursor:pointer; text-decoration: underline;">Date &#x25B2;&#x25BC;</th>
        <th>Part</th>
        <th>Operator</th>
        <th>Status</th>
        <th>Urgent</th>
        <th>Recurring</th>
      </tr>
    </thead>
    <tbody>
      <!-- Rows will be inserted dynamically -->
    </tbody>
  </table>
</div>

  <div class="modal" id="orderModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-describedby="modalDesc" tabindex="-1">
    <div class="modal-content">
     <form id="workOrderForm" autocomplete="off">
  <h2 id="modalTitle">Add Work Order</h2>
  <div id="modalDesc" style="margin-bottom:15px;">Fill the details below and save your work order.</div>

  <div class="form-group">
    <label for="orderTitle">Title</label>
    <input type="text" id="orderTitle" name="orderTitle" required autocomplete="off" />
  </div>

  <div class="form-group">
    <label for="orderDesc">Description</label>
    <textarea id="orderDesc" name="orderDesc" required></textarea>
  </div>

  <div class="form-group">
    <label for="orderDateTime">Date & Time</label>
    <input type="datetime-local" id="orderDateTime" name="orderDateTime" required />

  </div>

  <div class="form-group">
    <label for="orderPart">Part</label>
    <select id="orderPart" name="orderPart" required>
      <option value="Boiler Station">Boiler Station</option>
      <option value="Palm Oil Station">Palm Oil Station</option>
      
    </select>
  </div>

  <div class="form-group">
    <label for="orderOperator">Operator</label>
    <select id="orderOperator" name="orderOperator" required>
      <option value="">Select Operator</option>
      <option value="Yousif Abu Taam">Yousif Abu Taam</option>
     
    </select>
  </div>

  <div class="form-group">
    <label for="orderStatus">Status</label>
    <select id="orderStatus" name="orderStatus" required>
      <option value="To Do">To Do</option>
      <option value="Done">Done</option>
    </select>
  </div>

  <div class="form-group urgent-group">
    <input type="checkbox" id="orderUrgent" name="orderUrgent" />
    <label for="orderUrgent" style="color:#e74c3c;">Mark as Urgent</label>
  </div>

  <!-- Recurring checkbox -->
   
  <div class="form-group">
    <label style="color: #007acc;">
  <input type="checkbox" id="orderRecurring" name="orderRecurring" />
   Is Recurring?
</label>
  </div>

  <!-- Recurrence frequency (hidden by default) -->
  <div class="form-group" id="recurrenceSettings" style="display:none;">
    <label for="orderFrequency">Recurrence Frequency</label>
    <select id="orderFrequency" name="orderFrequency">
      <option value="none">None</option>
      <option value="daily">Daily</option>
      <option value="weekly">Weekly</option>
      <option value="monthly">Monthly</option>
    </select>
  </div>

  <!-- Recurrence end date (hidden by default) -->
  <div class="form-group" id="recurrenceEndDateContainer" style="display:none;">
    <label for="orderRecurrenceEndDate">Recurrence End Date</label>
    <input type="date" id="orderRecurrenceEndDate" name="orderRecurrenceEndDate" />
  </div>

  <div class="button-row">
    <button type="submit" id="saveBtn">Save</button>
    <button type="button" id="cancelBtn">Cancel</button>
    <button type="button" id="deleteBtn" style="background-color:#e74c3c; color:white; display:none;">Delete</button>
  </div>
</form>


      <div class="right-panel" id="chatPanel" aria-live="polite" aria-relevant="additions" style="display:none;">
        <h3>Chat</h3>
        <div id="chatMessages" tabindex="0" style="min-height:150px;"></div>
        <textarea id="chatInput" placeholder="Type message..." rows="2" aria-label="Chat input"></textarea>
        <button id="sendChatBtn" disabled>Send</button>
      </div>
    </div>
  </div>

  <div id="alertBar" class="alert-bar" style="display:none;">
    <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
    <span id="alertText"></span>
  </div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

 <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script>
  function matchesFilter(wo) {
  // Status filter (show all if 'All')
  const statusMatch = (currentStatus === 'All' || wo.status === currentStatus);

  // Station filter: make lowercase, partial match allowed, 'all' disables filtering
  const stationFilterValue = currentStation.toLowerCase();
  const partValue = (wo.part || '').toLowerCase();
  const stationMatch = (stationFilterValue === 'all' || partValue.includes(stationFilterValue));

  // Urgent filter (show only urgent if toggled on)
  const urgentMatch = (!showUrgentOnly || wo.urgent);

  // Only pass work orders that match all filters
  return statusMatch && stationMatch && urgentMatch;
}
  // === Variables & state ===
  
  let currentStatus = 'All';
  let currentStation = 'all';
  let showUrgentOnly = false;

  let workOrders = JSON.parse(localStorage.getItem('workOrders')) || [];
  let chatData = JSON.parse(localStorage.getItem('chatData')) || {};

  // NEW: occurrenceStatus stores status for individual recurring occurrences
  let occurrenceStatus = JSON.parse(localStorage.getItem('occurrenceStatus')) || {};

  // New variables for view toggle and sorting
  const calendarViewBtn = document.getElementById('calendarViewBtn');
  const tableViewBtn = document.getElementById('tableViewBtn');
  const tableViewContainer = document.getElementById('tableViewContainer');
  const calendarEl = document.getElementById('calendar');
  const workOrdersTableBody = document.querySelector('#workOrdersTable tbody');
  const dateHeader = document.getElementById('dateHeader');

  // Save occurrenceStatus to localStorage
  function saveOccurrenceStatus() {
    localStorage.setItem('occurrenceStatus', JSON.stringify(occurrenceStatus));
  }

  calendarViewBtn.addEventListener('click', () => {
    calendarViewBtn.classList.add('active');
    calendarViewBtn.setAttribute('aria-pressed', 'true');
    tableViewBtn.classList.remove('active');
    tableViewBtn.setAttribute('aria-pressed', 'false');
    calendarEl.style.display = 'block';
    tableViewContainer.style.display = 'none';
    renderCalendar();
  });

  tableViewBtn.addEventListener('click', () => {
    tableViewBtn.classList.add('active');
    tableViewBtn.setAttribute('aria-pressed', 'true');
    calendarViewBtn.classList.remove('active');
    calendarViewBtn.setAttribute('aria-pressed', 'false');
    calendarEl.style.display = 'none';
    tableViewContainer.style.display = 'block';
    renderTableView();
  });

  let currentView = 'calendar';  // default view
  let sortAscending = true;      // date sort order

  // === DOM references for recurrence ===
  const orderRecurringCheckbox = document.getElementById('orderRecurring');
  const recurrenceSettings = document.getElementById('recurrenceSettings');
  const recurrenceEndDateContainer = document.getElementById('recurrenceEndDateContainer');

  // === Dark mode ===
  const darkToggle = document.getElementById('darkModeToggle');
  const darkIcon = darkToggle.querySelector('i');
  function updateDarkModeButton() {
    if (document.body.classList.contains('dark-mode')) {
      darkIcon.className = 'fas fa-moon';
      darkToggle.title = "Switch to Light Mode";
    } else {
      darkIcon.className = 'fas fa-sun';
      darkToggle.title = "Switch to Dark Mode";
    }
  }
  darkToggle.addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    updateDarkModeButton();
  });
  if (localStorage.getItem('darkMode') === 'true') {
    document.body.classList.add('dark-mode');
  }
  updateDarkModeButton();

  // === Alert bar ===
  const alertBar = document.getElementById('alertBar');
  const alertText = document.getElementById('alertText');
  function showAlert(message) {
    alertText.textContent = message;
    alertBar.style.display = 'flex';
    setTimeout(() => {
      alertBar.style.display = 'none';
    }, 15000);
  }

  // === Filter buttons ===
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const type = btn.dataset.type;
      const value = btn.dataset.filter;

      if (type === 'status') {
        currentStatus = value;
        document.querySelectorAll('[data-type="status"]').forEach(b => {
          b.classList.remove('active');
          b.setAttribute('aria-pressed', 'false');
        });
        btn.classList.add('active');
        btn.setAttribute('aria-pressed', 'true');
      } else if (type === 'station') {
  currentStation = value.trim().toLowerCase();  // normalize filter value
  document.querySelectorAll('[data-type="station"]').forEach(b => {
    b.classList.remove('active');
    b.setAttribute('aria-pressed', 'false');
  });
  btn.classList.add('active');
  btn.setAttribute('aria-pressed', 'true');

      } else if (type === 'urgent') {
        showUrgentOnly = !showUrgentOnly;
        btn.classList.toggle('active');
        btn.setAttribute('aria-pressed', showUrgentOnly ? 'true' : 'false');
      }
      if(currentView === 'calendar') {
        renderCalendar();
      } else {
        renderTableView();
      }
    });
  });

  // === Save & load ===
  function saveWorkOrders() {
    localStorage.setItem('workOrders', JSON.stringify(workOrders));
  }
  function saveChatData() {
    localStorage.setItem('chatData', JSON.stringify(chatData));
  }

  // === Filter workOrders by current filters ===
  // Filtering now happens on expanded orders below

  // === Render table view function ===
  function renderTableView() {
    tableViewContainer.style.display = 'block';
    calendarEl.style.display = 'none';
    calendarViewBtn.disabled = false;
    tableViewBtn.disabled = true;

    // Use expanded orders with overridden occurrence statuses
    let expandedOrders = getExpandedWorkOrders();

let filteredOrders = expandedOrders.filter(wo => matchesFilter(wo));

    filteredOrders.sort((a,b) => 
      sortAscending
        ? new Date(a.date) - new Date(b.date)
        : new Date(b.date) - new Date(a.date)
    );

    workOrdersTableBody.innerHTML = '';

    filteredOrders.forEach(wo => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${escapeHtml(wo.title)}</td>
        <td>${escapeHtml(wo.desc)}</td>
        <td>${new Date(wo.date).toLocaleString()}</td>
        <td>${escapeHtml(wo.part)}</td>
        <td>${escapeHtml(wo.operator)}</td>
        <td>${escapeHtml(wo.status)}</td>
        <td>${wo.urgent ? 'Yes' : 'No'}</td>
        <td>${wo.isRecurring ? 'Yes' : 'No'}</td>
      `;
      row.style.cursor = 'pointer';
      row.addEventListener('click', () => {
        const event = calendar.getEventById(wo.id);
        openModal(event || null);
      });
      workOrdersTableBody.appendChild(row);
    });
  }

  // === View toggle buttons handlers ===
  calendarViewBtn.addEventListener('click', () => {
    currentView = 'calendar';
    calendarEl.style.display = 'block';
    tableViewContainer.style.display = 'none';
    calendarViewBtn.disabled = true;
    tableViewBtn.disabled = false;
    renderCalendar();
  });

  tableViewBtn.addEventListener('click', () => {
    currentView = 'table';
    renderTableView();
  });

  // === Sort table by clicking date header ===
  dateHeader.addEventListener('click', () => {
    sortAscending = !sortAscending;
    if (currentView === 'table') renderTableView();
  });

  // === Recurrence toggle logic ===
  function toggleRecurrenceFields() {
    if (orderRecurringCheckbox.checked) {
      recurrenceSettings.style.display = 'block';
      recurrenceEndDateContainer.style.display = 'block';
    } else {
      recurrenceSettings.style.display = 'none';
      recurrenceEndDateContainer.style.display = 'none';
      document.getElementById('orderFrequency').value = 'none';
      document.getElementById('orderRecurrenceEndDate').value = '';
    }
  }
  orderRecurringCheckbox.addEventListener('change', toggleRecurrenceFields);
  toggleRecurrenceFields(); // initialize on load

  // === Calendar and modal ===
  const addOrderBtn = document.getElementById('addOrderBtn');
  const clearCalendarBtn = document.getElementById('clearCalendarBtn');

  const modal = document.getElementById('orderModal');
  const form = document.getElementById('workOrderForm');
  const saveBtn = document.getElementById('saveBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const deleteBtn = document.getElementById('deleteBtn');

  const chatPanel = document.getElementById('chatPanel');
  const chatMessages = document.getElementById('chatMessages');
  const chatInput = document.getElementById('chatInput');
  const sendChatBtn = document.getElementById('sendChatBtn');

  let currentEvent = null; // currently editing event

  // Initialize calendar
  let calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    selectable: true,
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,timeGridDay'
    },
    eventDidMount: (info) => {
      if (info.event.extendedProps.urgent) {
        info.el.classList.add('urgent-event');
      }
    },
    events: [],
    eventClick: (info) => {
      openModal(info.event);
    },
    select: (selectionInfo) => {
      openModal(null, selectionInfo.startStr);
    }
  });
  calendar.render();

  // Open modal - if event is null, means new event, else edit
  function openModal(event = null, selectedDate = null) {
    currentEvent = event;
    form.reset();
    deleteBtn.style.display = 'none';
    chatPanel.style.display = 'flex';
    chatMessages.innerHTML = '';
    chatInput.value = '';
    sendChatBtn.disabled = true;

    if (event) {
      // Edit mode
      document.getElementById('modalTitle').textContent = 'Edit Work Order';
      form.orderTitle.value = event.title;
      form.orderDesc.value = event.extendedProps.desc || '';
      form.orderDateTime.value = event.startStr.slice(0,16);
      form.orderPart.value = event.extendedProps.part || 'Other';
      form.orderOperator.value = event.extendedProps.operator || '';
      form.orderStatus.value = event.extendedProps.status || 'To Do';
      form.orderUrgent.checked = event.extendedProps.urgent || false;

      // Recurrence fields populate
      form.orderRecurring.checked = event.extendedProps.isRecurring || false;
      form.orderFrequency.value = event.extendedProps.frequency || 'none';
      form.orderRecurrenceEndDate.value = event.extendedProps.recurrenceEndDate || '';
      toggleRecurrenceFields();

      deleteBtn.style.display = 'inline-block';

      // Load chat for this event
      const eventId = event.extendedProps.id;
if (eventId) {
  renderChatMessages(eventId);
  chatPanel.style.display = 'flex';
  chatInput.focus();
} else {
  chatPanel.style.display = 'none';
}
    } else {
      // New mode
      document.getElementById('modalTitle').textContent = 'Add Work Order';
      if (selectedDate) {
      form.orderDateTime.value = selectedDate.slice(0,16);

      } else {
        form.orderDateTime.value = new Date().toISOString().slice(0,16);

      }
      form.orderRecurring.checked = false;
      toggleRecurrenceFields();
    }

    modal.style.display = 'flex';
    form.orderTitle.focus();
  }

  // Close modal
  function closeModal() {
    modal.style.display = 'none';
    currentEvent = null;
  }

  // Save form with recurrence validation and save
  form.addEventListener('submit', (e) => {
    e.preventDefault();

    // Validate recurrence fields if recurring checked
    if (form.orderRecurring.checked) {
      const freq = form.orderFrequency.value;
      const endDate = form.orderRecurrenceEndDate.value;
      const startDate = form.orderDateTime.value;

      if (freq === 'none') {
        alert('Please select a recurrence frequency.');
        return;
      }
      if (!endDate) {
        alert('Please select a recurrence end date.');
        return;
      }
      if (new Date(endDate) <= new Date(startDate)) {
        alert('Recurrence end date must be after the task date.');
        return;
      }
    }

    const order = {
      id: currentEvent ? currentEvent.extendedProps.id : `wo-${Date.now()}`,
      title: form.orderTitle.value.trim(),
      desc: form.orderDesc.value.trim(),
      date: form.orderDateTime.value,
      part: form.orderPart.value,
      operator: form.orderOperator.value,
      status: form.orderStatus.value,
      urgent: form.orderUrgent.checked,

      isRecurring: form.orderRecurring.checked,
      frequency: form.orderRecurring.checked ? form.orderFrequency.value : 'none',
      recurrenceEndDate: form.orderRecurring.checked ? form.orderRecurrenceEndDate.value : ''
    };

    // Detect if editing an occurrence (id contains date suffix and NOT base order id)
    const isOccurrence = currentEvent && currentEvent.extendedProps.id.includes('-') && !workOrders.some(w => w.id === currentEvent.extendedProps.id);

    if (currentEvent) {
      if (isOccurrence) {
        // Update only occurrence status
        occurrenceStatus[order.id] = order.status;
        saveOccurrenceStatus();
      } else {
        // Update base task
        const idx = workOrders.findIndex(w => w.id === order.id);
        if (idx !== -1) {
          workOrders[idx] = order;
          saveWorkOrders();
        }
      }
    } else {
      // New task
      workOrders.push(order);
      saveWorkOrders();
    }

    if (currentView === 'calendar') {
      renderCalendar();
    } else {
      renderTableView();
    }
    closeModal();
  });

  // Cancel button
  cancelBtn.addEventListener('click', () => {
    closeModal();
  });

  // Delete button
  deleteBtn.addEventListener('click', () => {
    if (currentEvent) {
      const idToDelete = currentEvent.extendedProps.id;
      const isOccurrence = !workOrders.some(w => w.id === idToDelete);

      if (isOccurrence) {
        // Delete occurrence status only
        delete occurrenceStatus[idToDelete];
        saveOccurrenceStatus();
      } else {
        // Delete full base task
        workOrders = workOrders.filter(w => w.id !== idToDelete);
        saveWorkOrders();
      }

      delete chatData[idToDelete];
      saveChatData();

      if(currentView === 'calendar') {
        renderCalendar();
      } else {
        renderTableView();
      }
      closeModal();
    }
  });

  // Add order button
  addOrderBtn.addEventListener('click', () => openModal());

  // Clear calendar button
  clearCalendarBtn.addEventListener('click', () => {
    if (confirm('Are you sure you want to clear all work orders? This action cannot be undone.')) {
      workOrders = [];
      chatData = {};
      occurrenceStatus = {};
      saveWorkOrders();
      saveChatData();
      saveOccurrenceStatus();
      if(currentView === 'calendar') {
        renderCalendar();
      } else {
        renderTableView();
      }
    }
  });

  // Chat functionality
  chatInput.addEventListener('input', () => {
    sendChatBtn.disabled = chatInput.value.trim() === '';
  });

  sendChatBtn.addEventListener('click', () => {
    const msg = chatInput.value.trim();
    if (!msg) return;

    const eventId = currentEvent.extendedProps.id;
    if (!chatData[eventId]) {
      chatData[eventId] = [];
    }
    const now = new Date().toISOString();
    chatData[eventId].push({ message: msg, timestamp: now });
    saveChatData();
    renderChatMessages(eventId);
    chatInput.value = '';
    sendChatBtn.disabled = true;
    chatInput.focus();
  });

  function renderChatMessages(eventId) {
    const msgs = chatData[eventId] || [];
    chatMessages.innerHTML = '';
    msgs.forEach(chat => {
      const div = document.createElement('div');
      div.className = 'chat-message';
      const time = new Date(chat.timestamp).toLocaleString();
      div.innerHTML = `<div class="meta">${time}</div><div>${escapeHtml(chat.message)}</div>`;
      chatMessages.appendChild(div);
    });
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // Escape HTML to avoid injection
  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, function(m) {
      return ({"&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"}[m]);
    });
  }

  // Expand recurring tasks into multiple calendar events based on frequency and end date
  function getExpandedWorkOrders() {
    const expanded = [];

    workOrders.forEach(order => {
      if (order.isRecurring && order.frequency !== 'none' && order.recurrenceEndDate) {
        const freq = order.frequency;
        const startDate = new Date(order.date);
        const endDate = new Date(order.recurrenceEndDate);

        const baseOrder = { ...order };

        let currentDate = new Date(startDate);

        while (currentDate <= endDate) {
          const dateStr = currentDate.toISOString().slice(0,10);
          const occurrenceId = order.id + '-' + dateStr;

          expanded.push({
            ...baseOrder,
            id: occurrenceId,
            date: dateStr,
            // OVERRIDE status with occurrenceStatus if exists, else use base order status
            status: occurrenceStatus[occurrenceId] || order.status,
          });

          if (freq === 'daily') {
            currentDate.setDate(currentDate.getDate() + 1);
          } else if (freq === 'weekly') {
            currentDate.setDate(currentDate.getDate() + 7);
          } else if (freq === 'monthly') {
            currentDate.setMonth(currentDate.getMonth() + 1);
          } else {
            break;
          }
        }
      } else {
        expanded.push(order);
      }
    });

    return expanded;
  }

  // Render calendar events filtered & expanded recurring
  function renderCalendar() {
  calendar.removeAllEvents();

  let expandedOrders = getExpandedWorkOrders();

  let filteredOrders = expandedOrders.filter(wo => matchesFilter(wo));

  filteredOrders.forEach(order => {
    calendar.addEvent({
      id: order.id,
      title: order.title,
      start: order.date,
      extendedProps: {
        desc: order.desc,
        part: order.part,
        operator: order.operator,
        status: order.status,
        urgent: order.urgent,
        id: order.id,
        isRecurring: order.isRecurring,
        frequency: order.frequency,
        recurrenceEndDate: order.recurrenceEndDate
      },
      color: order.urgent ? '#e74c3c' : undefined
    });
  });
}


  // Initial render
  renderCalendar();
document.getElementById('exportPdfBtn').addEventListener('click', () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.setFontSize(16);
  doc.text("Work Orders Table", 14, 20);

  const headers = [["Title", "Description", "Date", "Part", "Operator", "Status", "Urgent", "Recurring"]];

  const rows = [];
  const expandedOrders = getExpandedWorkOrders().filter(wo => matchesFilter(wo));
  expandedOrders.forEach(wo => {
    rows.push([
      wo.title,
      wo.desc,
      new Date(wo.date).toLocaleString(),
      wo.part,
      wo.operator,
      wo.status,
      wo.urgent ? "Yes" : "No",
      wo.isRecurring ? "Yes" : "No"
    ]);
  });

  doc.autoTable({
    head: headers,
    body: rows,
    startY: 30,
    styles: {
      fontSize: 10,
      cellPadding: 2
    },
    headStyles: {
      fillColor: [74, 144, 226]  // blue header
    }
  });

  doc.save("WorkOrders.pdf");
});

</script>



</body>
</html>
